---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

const entries = await getCollection('now');

const sortedEntries = entries.sort((a, b) =>
	new Date(b.data.date).getTime() - new Date(a.data.date).getTime()
);

const timeline = await Promise.all(
	sortedEntries.map(async (entry) => {
		const { Content } = await entry.render();
		const raw = entry.data.date;
		const date = raw instanceof Date ? raw : new Date(raw);

		const label = date.toLocaleDateString('en-US', {
			month: 'numeric',
			day: 'numeric',
			year: '2-digit',
		});

		return { ...entry, Content, label };
	})
);
---

<BaseLayout title="Now" description="A running timeline of notes and links.">
	<div class="max-w-4xl mx-auto px-6 py-20">
		<div class="mb-10">
			<h1 class="text-3xl font-bold tracking-tighter">Now</h1>
			<p class="mt-2 text-sm text-charcoal/70">Date-indexed log.</p>
		</div>

		{timeline.length === 0 ? (
			<p class="text-charcoal/70">No entries yet.</p>
		) : (
			<div class="space-y-4">
				{timeline.map((entry, index) => {
					const { Content } = entry;
					return (
						<details class="now-entry" open={index === 0}>
							<summary class="now-entry__summary">
								<span class="now-entry__date">{entry.label}</span>
								{entry.data.summary && <span class="now-entry__blurb">{entry.data.summary}</span>}
							</summary>
							<div class="now-entry__content prose prose-invert max-w-none">
								<Content />
								{entry.data.links?.length ? (
									<ul class="mt-6 space-y-1 now-links">
										{entry.data.links.map((link) => (
											<li><a href={link.url}>{link.label ?? link.url}</a></li>
										))}
									</ul>
								) : null}
							</div>
						</details>
					);
				})}
			</div>
		)}
	</div>
</BaseLayout>

<style>
	.now-entry {
		border: 1px solid rgba(255, 255, 255, 0.18);
		background: #000;
	}

	.now-entry__summary {
		list-style: none;
		cursor: pointer;
		padding: 1rem 1.1rem;
		display: grid;
		gap: 0.28rem;
		border-left: 2px solid rgba(255, 255, 255, 0.5);
	}

	.now-entry__summary::-webkit-details-marker {
		display: none;
	}

	.now-entry__date {
		font-size: 0.85rem;
		letter-spacing: 0.12em;
		text-transform: uppercase;
		font-family: 'Geist Mono', 'Geist Pixel', monospace;
	}

	.now-entry__blurb {
		font-size: 0.82rem;
		opacity: 0.7;
	}

	.now-entry__content {
		padding: 0.35rem 1.1rem 1.1rem;
	}

	.now-links a {
		font-family: 'Geist Mono', monospace;
		font-size: 0.85rem;
		word-break: break-all;
	}
</style>
