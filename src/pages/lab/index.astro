---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Rive from '../../components/interactive/Rive.astro';
import { resolveRiveRecipe } from '../../content/rive-recipes';
import fs from 'node:fs';
import path from 'node:path';

const riveDirPath = path.join(process.cwd(), 'public', 'rive');

type RiveAsset = {
	name: string;
	path: string;
	src: string;
	size: string;
	category: string;
	metadata?: {
		description?: string;
		tags?: string[];
		source?: string;
	};
};

function getAssets(dir: string, baseDir: string): RiveAsset[] {
	if (!fs.existsSync(dir)) return [];
	const entries = fs.readdirSync(dir, { withFileTypes: true });
	let assets: RiveAsset[] = [];

	for (const entry of entries) {
		const fullPath = path.join(dir, entry.name);
		const relativePath = path.relative(baseDir, fullPath);

		if (entry.isDirectory()) {
			assets = [...assets, ...getAssets(fullPath, baseDir)];
		} else if (entry.name.endsWith('.riv')) {
			const stat = fs.statSync(fullPath);
			const kb = (stat.size / 1024).toFixed(1);
			const name = relativePath.replace('.riv', '');
			const category = path.dirname(relativePath) === '.' ? 'General' : path.dirname(relativePath);
			
			const metaPath = fullPath.replace('.riv', '.json');
			let metadata = undefined;
			if (fs.existsSync(metaPath)) {
				try {
					metadata = JSON.parse(fs.readFileSync(metaPath, 'utf8'));
				} catch (e) {
					console.error(`Failed to parse metadata for ${name}`);
				}
			}

			assets.push({
				name: path.basename(name),
				path: name,
				src: `/rive/${relativePath}`,
				size: `${kb} KB`,
				category,
				metadata,
			});
		}
	}
	return assets;
}

const allAssets = getAssets(riveDirPath, riveDirPath).sort((a, b) => a.path.localeCompare(b.path));
const categories = [...new Set(allAssets.map(a => a.category))].sort();
const previewRecipe = resolveRiveRecipe('labCardPreview');
---

<BaseLayout title="Motion Lab">
	<div class="max-w-4xl mx-auto px-6 py-12">
		<div class="mb-4">
			<h1 class="text-3xl font-bold mb-2">Motion Lab</h1>
			<p class="text-gray-600 text-sm">
				{allAssets.length} asset{allAssets.length !== 1 ? 's' : ''} organized by category
			</p>
		</div>

		{allAssets.length === 0 ? (
			<div class="border-2 border-dashed border-gray-300 p-12 text-center">
				<p class="text-gray-600 mb-2">No .riv files found.</p>
				<p class="text-sm text-gray-500">
					Drop <code class="bg-gray-100 px-1 py-0.5 text-xs">.riv</code> files
					into <code class="bg-gray-100 px-1 py-0.5 text-xs">public/rive/</code> and
					refresh.
				</p>
			</div>
		) : (
			<div id="lab-motion-grid" class="space-y-12" data-motion-chapter>
				{categories.map((category) => (
					<section data-motion-chapter>
						<h2 class="text-xs font-bold uppercase tracking-wider text-gray-400 mb-6 flex items-center gap-2">
							<span class="w-2 h-2 bg-black rounded-full"></span>
							{category}
						</h2>
						<div class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3">
							{allAssets
								.filter((a) => a.category === category)
								.map((asset) => (
									<a
										href={`/lab/${asset.path}`}
										class="border border-black block hover:bg-gray-50 transition-colors group focus-visible:outline-2 focus-visible:outline-raw focus-visible:outline-offset-2 motion-lab-card"
										data-lab-motion-card
										data-card-path={asset.path}
									>
										<div class="aspect-square bg-gray-50 border-b border-gray-200 flex items-center justify-center overflow-hidden">
											<Rive
												src={asset.src}
												recipe={previewRecipe}
												id={`lab-card-${asset.path.replace(/[\\/]/g, '-')}`}
												class="w-full h-full"
											>
												<div slot="fallback" class="lab-rive-fallback" aria-hidden="true">
													<span>Preview</span>
												</div>
											</Rive>
										</div>
										<div class="p-4">
											<div class="flex items-center justify-between mb-1">
												<p class="font-bold text-sm group-hover:underline">{asset.name}</p>
												<span class="text-[10px] font-mono text-gray-400 uppercase">{asset.size}</span>
											</div>
											{asset.metadata?.description && (
												<p class="text-xs text-gray-500 line-clamp-2 mb-2 leading-relaxed">
													{asset.metadata.description}
												</p>
											)}
											{asset.metadata?.tags && (
												<div class="flex flex-wrap gap-1">
													{asset.metadata.tags.map((tag: string) => (
														<span class="px-1.5 py-0.5 bg-gray-100 text-[9px] text-gray-600 rounded-sm">
															{tag}
														</span>
													))}
												</div>
											)}
										</div>
									</a>
								))}
						</div>
					</section>
				))}
			</div>
		)}
	</div>

	<script type="module">
		(() => {
			const root = document.getElementById('lab-motion-grid');
			if (!(root instanceof HTMLElement)) {
				return;
			}

			const cards = Array.from(root.querySelectorAll('[data-lab-motion-card]'));
			if (!cards.length) {
				return;
			}

			const reduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
			if (reduced) {
				cards.forEach((card) => card.classList.add('is-awake'));
				return;
			}

			const observer = new IntersectionObserver(
				(entries) => {
					entries.forEach((entry) => {
						if (!entry.isIntersecting) return;
						const card = entry.target;
						if (!(card instanceof HTMLElement) || card.classList.contains('is-awake')) return;
						const index = cards.indexOf(card);
						window.setTimeout(() => {
							card.classList.add('is-awake');
						}, Math.max(0, index) * 55);
						observer.unobserve(card);
					});
				},
				{ threshold: 0.2, rootMargin: '0px 0px -8% 0px' }
			);

			cards.forEach((card) => observer.observe(card));

			const setActive = (active) => {
				cards.forEach((card) => {
					if (active && card !== active) {
						card.classList.add('is-dimmed');
					} else {
						card.classList.remove('is-dimmed');
					}
				});
			};

			cards.forEach((card) => {
				const enter = () => setActive(card);
				const leave = (event) => {
					const related = event instanceof FocusEvent ? event.relatedTarget : null;
					if (related instanceof Node && card.contains(related)) return;
					setActive(null);
				};
				card.addEventListener('mouseenter', enter);
				card.addEventListener('focusin', enter);
				card.addEventListener('mouseleave', leave);
				card.addEventListener('focusout', leave);
			});

			document.addEventListener('astro:before-preparation', () => {
				observer.disconnect();
			});
		})();
	</script>
</BaseLayout>
