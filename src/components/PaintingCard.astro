---
/**
 * PaintingCard.astro
 * ==================
 * Renders a project as a card in the portfolio gallery.
 *
 * When a vimeoId is provided, the card displays an autoplaying
 * Vimeo embed (muted, looping, no controls) that plays/pauses
 * as the user scrolls it in and out of view.
 *
 * Otherwise falls back to a dark placeholder div with the title.
 *
 * The card links to the individual project detail page.
 */

interface Props {
	title: string;
	medium: string;
	dimensions: string;
	year: number;
	image: string;
	slug: string;
	featured?: boolean;
	available?: boolean;
	series?: string;
	vimeoId?: string;
	class?: string;
}

const {
	title,
	medium,
	dimensions,
	year,
	image,
	slug,
	featured = false,
	available = false,
	series,
	vimeoId,
	class: className = '',
} = Astro.props;
---

<a
	href={`/portfolio/${slug}`}
	class:list={[
		'painting-card group block',
		{ 'painting-card--featured': featured },
		className,
	]}
>
	<!-- The Frame: matted border with stamped shadow -->
	<div class="painting-card__frame">
		<div class="painting-card__mat">
			{vimeoId ? (
				<div class="vimeo-scroll-player" style="position:relative;aspect-ratio:16/9;overflow:hidden;">
					<iframe
						data-src={`https://player.vimeo.com/video/${vimeoId}?background=1&autoplay=0&loop=1&muted=1&dnt=1`}
						style="position:absolute;top:0;left:0;width:100%;height:100%;border:0;"
						allow="autoplay; fullscreen"
						loading="lazy"
						title={title}
					></iframe>
				</div>
			) : (
				<div
					style="aspect-ratio:4/3;display:flex;align-items:center;justify-content:center;background:#1a1a1a;color:rgba(255,255,255,0.25);font-family:monospace;font-size:0.75rem;text-transform:uppercase;letter-spacing:0.1em;"
					class="painting-card__image"
				>
					{title}
				</div>
			)}
		</div>
	</div>

	<!-- Gallery Label: monospaced metadata block -->
	<div class="painting-card__label">
		<h3 class="painting-card__title">
			{title}
			{available && <span class="painting-card__available" title="Available">‚óè</span>}
		</h3>
		<p class="painting-card__meta">
			{medium}, {year}
		</p>
		<p class="painting-card__dimensions">
			{dimensions}
		</p>
		{series && (
			<p class="painting-card__series">
				{series}
			</p>
		)}
	</div>
</a>

<script>
	function initScrollPlayers() {
		const players = document.querySelectorAll('.vimeo-scroll-player');
		if (!players.length) return;

		const observer = new IntersectionObserver((entries) => {
			entries.forEach((entry) => {
				const iframe = entry.target.querySelector('iframe') as HTMLIFrameElement | null;
				if (!iframe) return;

				if (entry.isIntersecting) {
					// Lazy-load: set src on first intersection
					if (!iframe.src && iframe.dataset.src) {
						iframe.src = iframe.dataset.src.replace('autoplay=0', 'autoplay=1');
					} else if (iframe.contentWindow) {
						iframe.contentWindow.postMessage(
							JSON.stringify({ method: 'play' }), '*'
						);
					}
				} else {
					if (iframe.contentWindow && iframe.src) {
						iframe.contentWindow.postMessage(
							JSON.stringify({ method: 'pause' }), '*'
						);
					}
				}
			});
		}, { threshold: 0.25 });

		players.forEach((player) => observer.observe(player));
	}

	// Run on initial load and on Astro page transitions
	initScrollPlayers();
	document.addEventListener('astro:page-load', initScrollPlayers);
</script>
