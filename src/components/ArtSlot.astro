---
import type { ArtFit, ArtSlotConfig, ArtReveal, ArtTreatment } from '../content/art-manifest';
import { resolveRiveRecipe } from '../content/rive-recipes';
import { existsSync } from 'node:fs';
import { resolve } from 'node:path';
import ArtPlate from './ArtPlate.astro';
import RivePlayer from './interactive/RivePlayer.astro';

interface Props {
	slot?: ArtSlotConfig;
	fallbackLabel?: string;
	class?: string;
	caption?: string;
	treatment?: ArtTreatment;
}

const {
	slot,
	fallbackLabel,
	class: className = '',
	caption,
	treatment,
} = Astro.props;

function hasAsset(src?: string) {
	if (!src) return false;
	if (/^https?:\/\//.test(src)) return true;
	return existsSync(resolve(process.cwd(), 'public', src.replace(/^\//, '')));
}

const primaryAssetExists = hasAsset(slot?.src);
const fallbackAssetExists = hasAsset(slot?.fallbackSrc);
const isEnabled = Boolean(slot?.enabled);
const hasRenderableAsset = Boolean(primaryAssetExists || fallbackAssetExists);
const isRenderable = Boolean(isEnabled && hasRenderableAsset);

const shouldRenderCaption = Boolean(slot?.showCaption && (caption ?? slot?.caption));
const resolvedCaption = shouldRenderCaption ? (caption ?? slot?.caption) : undefined;
const resolvedTreatment = treatment ?? slot?.treatment ?? 'flat';
const resolvedFit: ArtFit = slot?.fit ?? 'cover';
const resolvedPosition = slot?.position ?? '50% 50%';
const resolvedSurface = slot?.surface ?? 'none';
const loadingValue = slot?.priority ? 'eager' : 'lazy';
const fetchPriority = slot?.priority ? 'high' : undefined;

const [widthPart = '16', heightPart = '9'] = (slot?.aspect ?? '16:9').split(':');
const widthValue = Number(widthPart);
const heightValue = Number(heightPart);
const safeWidth = Number.isFinite(widthValue) && widthValue > 0 ? widthValue : 16;
const safeHeight = Number.isFinite(heightValue) && heightValue > 0 ? heightValue : 9;
const aspectRatio = `${safeWidth} / ${safeHeight}`;
const ratioPercent = `${(safeHeight / safeWidth) * 100}%`;

const revealMode: ArtReveal = slot?.animate === false ? 'none' : slot?.reveal ?? 'fade';
const revealClass = revealMode === 'none' ? '' : `art-reveal art-reveal--${revealMode}`;
const plateClass = ['art-slot', revealClass, className].filter(Boolean).join(' ');

const shouldShowRive = Boolean(slot?.type === 'rive' && isEnabled && primaryAssetExists);
const shouldShowVideo = Boolean(slot?.type === 'video' && isEnabled && primaryAssetExists);
const shouldShowImage = Boolean(slot?.type === 'image' && isEnabled && primaryAssetExists);
const riveRecipe = resolveRiveRecipe(slot?.riveRecipe);
const shouldShowDirectFallbackImage = Boolean(
	!shouldShowRive && !shouldShowVideo && !shouldShowImage && isEnabled && fallbackAssetExists,
);
---

<ArtPlate
	caption={resolvedCaption}
	class={plateClass}
	treatment={resolvedTreatment}
	surface={resolvedSurface}
	link={slot?.link}
>
	<div
		class="art-slot__frame"
		style={`--slot-aspect: ${aspectRatio}; --slot-ratio: ${ratioPercent}; --slot-fit: ${resolvedFit}; --slot-position: ${resolvedPosition};`}
	>
		{isRenderable ? (
			shouldShowImage || shouldShowDirectFallbackImage ? (
				<img
					src={shouldShowImage ? slot.src : slot.fallbackSrc}
					alt={slot.alt}
					loading={loadingValue}
					decoding="async"
					fetchpriority={fetchPriority}
					class="art-slot__media"
				/>
			) : shouldShowVideo ? (
				<video
					src={slot.src}
					class="art-slot__media"
					autoplay
					loop
					muted
					playsinline
					controls={false}
					aria-label={slot.alt}
				></video>
			) : (
				<RivePlayer
					src={slot.src}
					ariaLabel={slot.alt}
					class="art-slot__rive"
					artboard={riveRecipe?.artboard}
					stateMachine={riveRecipe?.stateMachine}
					mode={riveRecipe?.mode}
					autoplay={riveRecipe?.autoplay}
					inputs={riveRecipe?.inputs}
					interactions={riveRecipe?.interactions}
					debug={riveRecipe?.debug}
				>
					{fallbackAssetExists ? (
						<img
							slot="fallback"
							src={slot.fallbackSrc}
							alt={slot.alt}
							loading={loadingValue}
							decoding="async"
							class="art-slot__media art-slot__rive-fallback"
						/>
					) : (
						<div slot="fallback" class="art-slot__empty art-slot__rive-empty" aria-hidden="true">
							{fallbackLabel && <span>{fallbackLabel}</span>}
						</div>
					)}
				</RivePlayer>
			)
		) : (
			<div class="art-slot__empty" aria-hidden="true">
				{fallbackLabel && <span>{fallbackLabel}</span>}
			</div>
		)}
	</div>
</ArtPlate>
